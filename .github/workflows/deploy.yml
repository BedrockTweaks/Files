name: Deploy

on:
  push:
    branches: [ "main", "devel" ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Skip if the commit message indicates it's from the contributors action
    if: "!contains(github.event.head_commit.message, 'docs(contributor)')"

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Git LFS Pull
        run: git lfs pull

      # Step 1: Create project artifact
      # Ensure we're in a clean state
      - name: Create project archive
        run: |
          git clean -fdx
          
          tar -czf project.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            .

      # Step 2-dev: Deploy to development server
      - name: Deploy to dev server
        if: github.ref_name == 'devel'
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "project.tar.gz"
          target: "/opt/bedrock_tweaks/files_dev"

      - name: Extract files on dev server
        if: github.ref_name == 'devel'
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd "/opt/bedrock_tweaks/files_dev"
            tar -xzf project.tar.gz --strip-components=0 --overwrite
            rm project.tar.gz

      # Step 2-prod: Deploy to production server
      - name: Deploy to production server
        if: github.ref_name == 'main'
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "project.tar.gz"
          target: "/opt/bedrock_tweaks/files"

      - name: Extract files on production server
        if: github.ref_name == 'main'
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd "/opt/bedrock_tweaks/files"
            tar -xzf project.tar.gz --strip-components=0 --overwrite
            rm project.tar.gz

      - name: Output job status
        id: job-status
        if: ${{ always() }}
        run: |
          echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

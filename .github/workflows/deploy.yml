name: Deploy

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Skip if the commit message indicates it's from the contributors action
    if: ${{ !contains(github.event.head_commit.message, 'docs(contributor)') }}

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Git LFS Pull
        run: git lfs pull

      # Step 1: Clean and create project artifact
      - name: Clean project
        run: git clean -fdx

      - name: Compress project
        uses: somaz94/compress-decompress@v1
        with:
          command: compress
          source: .
          format: zip
          destfilename: project
          exclude: '.git .github node_modules'
          includeRoot: 'false'

      # Step 2-dev: Deploy to development server
      - name: Deploy to dev server
        if: github.ref_name == 'devel'
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "project.zip"
          target: "/opt/bedrock_tweaks/files_dev"

      - name: Extract files on dev server
        if: github.ref_name == 'devel'
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd "/opt/bedrock_tweaks/files_dev"
            # Remove all existing files/directories except the uploaded archive to avoid stale leftovers
            find . -mindepth 1 -maxdepth 1 ! -name 'project.zip' -exec rm -rf {} +
            unzip -o project.zip
            rm project.zip

      # Step 2-prod: Deploy to production server
      - name: Deploy to production server
        if: github.ref_name == 'main'
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "project.zip"
          target: "/opt/bedrock_tweaks/files"

      - name: Extract files on production server
        if: github.ref_name == 'main'
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd "/opt/bedrock_tweaks/files"
            # Remove all existing files/directories except the uploaded archive to avoid stale leftovers
            find . -mindepth 1 -maxdepth 1 ! -name 'project.zip' -exec rm -rf {} +
            unzip -o project.zip
            rm project.zip

      - name: Output job status
        id: job-status
        if: ${{ always() }}
        run: |
          echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
